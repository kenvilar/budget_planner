<!DOCTYPE html>


<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        
        <!-- <link rel="stylesheet" type="text/css" href="jquery.mobile-1.4.1.min.css">
		<script type="text/javascript" src="jquery.mobile-1.4.1.min.js"></script>
		<script type="text/javascript" src="jquery-2.1.0.min.js"></script> -->

		<link rel="stylesheet" type="text/css" href="jquery.mobile-1.4.1/jquery.mobile-1.4.1.min.css">
		<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="jquery.mobile-1.4.1/jquery.mobile-1.4.1.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
		<script type="text/javascript" charset="utf-8">	

			$(document).ready(function () {
				$('#txMoney').keyup(function () {
					$('#txTarget').val($('#txMoney').val()/2);
					$('#txTarget').attr('max',$('#txMoney').val());
				});
			});

			var db;
			var shortName = 'BudgetDB';
			var version = '1.0';
			var displayName = 'BudgetDB';
			var maxSize = 200;

			function errorHandler(transaction, error) {
   				alert('Error: ' + error.message + ' code: ' + error.code);
				}

			function successCallBack() {
   				alert("DEBUGGING: success");
 				}

			function nullHandler(){};

			function onBodyLoad(){
 				//alert("DEBUGGING: we are in the onBodyLoad() function");
 				if (!window.openDatabase) {
   					alert('Databases are not supported in this browser.');
   				return;
 				}
 
 				db = openDatabase(shortName, version, displayName,maxSize);
 	 			db.transaction(function(tx){

 				// Kung ganahan ta ug create-drop na db
  				//tx.executeSql( 'DROP TABLE BudgetDB',nullHandler,nullHandler);


 				tx.executeSql( 'CREATE TABLE IF NOT EXISTS BudgetDB(BudgetId INTEGER NOT NULL PRIMARY KEY, Name TEXT NOT NULL, Money INTEGER NOT NULL, Target INTEGER NOT NULL, Date Date NOT NULL)', [],nullHandler,errorHandler);},errorHandler,nullHandler);
				
				db.transaction(function(tx){

 				tx.executeSql( 'CREATE TABLE IF NOT EXISTS Expense(ExpenseId INTEGER NOT NULL PRIMARY KEY, Description TEXT NOT NULL, Amount INTEGER NOT NULL, Category TEXT NOT NULL, Occurence INTEGER NOT NULL, Date Date NOT NULL, Budget INTEGER)', [],nullHandler,errorHandler);},errorHandler,nullHandler);
				

 				ListDBValues();
 				GetName(id);
			}

			function ListDBValues() {
 				if (!window.openDatabase) {
  					alert('Databases are not supported in this browser.');
  				return;
 				}
 
 				html = '';
 				$('#Budgets').html('');
 
				db.transaction(function(transaction) {
   					transaction.executeSql('SELECT * FROM BudgetDB;', [],
     					function(transaction, result) {
      					if (result != null && result.rows != null) {
      						html = html + '<ul data-role="listview">';
        					for (var i = 0; i < result.rows.length; i++) {
          						var row = result.rows.item(i);
          					
    					        html += '<li>';
    					        html += '<a href="#editBudget" onClick=GetName(' + row.BudgetId +') class="ui-btn ui-corner-all ui-shadow ui-btn-icon-right ui-icon-carat-r">'+row.Name+ ' , ' + row.Target + '</a>';
    					        html += '</li>';
        						}
        					html += '</ul>';
        					$('#Budgets').append(html);
      						}
     					},errorHandler);
 					},errorHandler,nullHandler);
 
 					return;
 

			}
			
			function viewSummary() {
 				if (!window.openDatabase) {
  					alert('Databases are not supported in this browser.');
  				return;
 				}
 
 				html = '';
 				$('#viewSummaryPage').html('');
 				
 				var currentBudgetId = $('#currentBudgetID').val();
 				
				db.transaction(function(transaction) {
   					transaction.executeSql('SELECT * FROM Expense where Budget= ?;', [currentBudgetId],
     					function(transaction, result) {
      					if (result != null && result.rows != null) {
      						html = html + '<center><h2>Summary</h2><center>';
      						html = html + '<table border="1" style="width:100%">';
      						html += '<tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr>';
							var totalExpenses = 0;
							
							var month=new Array();
							month[0]="Jan";
							month[1]="Feb";
							month[2]="Mar";
							month[3]="Apr";
							month[4]="May";
							month[5]="Jun";
							month[6]="Jul";
							month[7]="Aug";
							month[8]="Sep";
							month[9]="Oct";
							month[10]="Nov";
							month[11]="Dec";
							
        					for (var i = 0; i < result.rows.length; i++) {
          						var row = result.rows.item(i);
								
								var myDate = new Date(row.Date);
								//var newDate = formatDate(myDate,"MMM d, y");
								totalExpenses += row.Amount;
    					        html += '<tr>';
    					        html += '<a><td>' + month[myDate.getMonth()] +'-'+myDate.getDate()+'-'+myDate.getFullYear()+ '</td> <td>'+ row.Description +' </td> <td>' + row.Category + '</td> <td>' + row.Amount + '</td></a>';
    					        html += '</tr>';
        						}
        					html += '</table>';
							html += '<h3><font color="">Total Expenses: ₱'+ totalExpenses +'</font></h3>';
        					html +=	'<a href="#editBudget" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back ui-btn-b">Back</a>';
        					$('#viewSummaryPage').append(html);
      						}
     					},errorHandler);
 					},errorHandler,nullHandler);
 
 					return;
			}




			function clearAddBudgetField() {
				$('#txTarget').val('');
				$('#txName').val('');
				$('#txMoney').val('');

				return;
			}

			function clearAddExpenseField() {
				$('#txDescription').val('');
				$('#txAmount').val('');
				$('#txOccurence').val('');
				return;
			}

			function AddValueToDB() {
				if (!window.openDatabase) {
					alert('Databases are not supported in this browser.');
					return;
				}

				db.transaction(function(transaction) {
					transaction.executeSql(
							'INSERT INTO BudgetDB(Name, Money, Target, Date) VALUES (?,?,?,?)',
							[ $('#txName').val(), $('#txMoney').val(), $('#txTarget').val(), $('#txDateCreated').val()],
							nullHandler, errorHandler);
				});

				ListDBValues();
				GetName(id);
				return false;
			}


			function AddExpense() {
				

				db.transaction(function(transaction) {
					transaction.executeSql('INSERT INTO Expense(Description, Amount, Category, Occurence, Date, Budget) VALUES (?,?,?,?,?,?)', [ $('#txDescription').val(), $('#txAmount').val(), $('#txCategory').val(), $('#txOccurence').val(), $('#txDate').val(), $('#currentBudgetID').val()], nullHandler, errorHandler);
				});

				
				GetName($('#currentBudgetID').val());
				$.mobile.changePage("index.html#editBudget");
				
				window.alert("Expense added successfully!");
				return;
			}
			

			function getDaysBetween(date1, date2) {
  					//Get 1 day in milliseconds
  					var one_day=1000*60*60*24;

  					// Convert both dates to milliseconds
 					var date1_ms = date1.getTime();
  					var date2_ms = date2.getTime();

  					// Calculate the difference in milliseconds
  					var difference_ms = date2_ms - date1_ms;
    
  					// Convert back to days and return
  					return Math.round(difference_ms/one_day); 
			}

			function GetName(id) {
				$('#currentBudgetID').val(id);
 				if (!window.openDatabase) {
  					alert('Databases are not supported in this browser.');
  					return;
 				}
 
 				$('#MyTarget').html('');
 				$('#MyName').html('');
				$('#dailyBudget').html('');
				$('#monthlyBudget').html('');
 				$('#MyMoney').html('');

				var budgetDate;
				var totalMoney;
				var targetSavings;
				var totalExpense = 0;
				var differences;
				var lastDayOfBudgetMonth;
				var monthlyBudgetLeft;
				var dailyBudgetLeft;

				db.transaction(function(transaction) {
   					transaction.executeSql('SELECT Name,Money,Date,Target,BudgetId FROM BudgetDB WHERE BudgetId = ?;', [id],
     					function(transaction, result) {
      					if (result != null && result.rows != null) {
        					for (var i = 0; i < result.rows.length; i++) {
          						var row = result.rows.item(i);
          						$('#MyName').append(row.Name);
          						$('#MyMoney').append(row.Money);
							budgetDate = new Date(row.Date);
							lastDayOfBudgetMonth = new Date(budgetDate.getFullYear(), budgetDate.getMonth() + 1, 0)
							totalMoney = row.Money;
							targetSavings = row.Target;
          						$('#MyTarget').append(row.Target);
          						$('#Myid').append(row.BudgetId);
          						$('#Myid').val(row.BudgetId);
        						}
      						}
     					},errorHandler);
 					},errorHandler,nullHandler);

					
					db.transaction(function(transaction) {
   					transaction.executeSql('SELECT * FROM Expense WHERE Budget = ?;', [id],
     					function(transaction, result) {
      					if (result != null && result.rows != null) {
						
        					for (var i = 0; i < result.rows.length; i++) {
          						var row = result.rows.item(i);
          							totalExpense = totalExpense + (row.Amount * row.Occurence);
        						}
						differences = getDaysBetween(budgetDate,lastDayOfBudgetMonth) + 1;
						monthlyBudgetLeft = (totalMoney - targetSavings) - totalExpense;
						dailyBudgetLeft = monthlyBudgetLeft / differences;
						$('#dailyBudget').append('<input type="text" id="totalDailyMoney" value="₱ '+ dailyBudgetLeft +'" readonly>');
						$('#monthlyBudget').append('<input type="text" id="totalMonthlyMoney" value="₱ '+ monthlyBudgetLeft +'" readonly>');
      						}
     					},errorHandler);
 					},errorHandler,nullHandler);
 					
					
 					return;
 

			}

			function DeleteBudget() {
				var id = $('#Myid').val();
				if (!window.openDatabase) {
					alert('Databases are not supported in this browser.');
					return;
				}

				if(confirm("Are you sure you want to delete?")) {
					db.transaction(function(transaction) {
						transaction.executeSql(
								'DELETE FROM BudgetDB WHERE BudgetId = ?;',
								[id],
								nullHandler, errorHandler);
					});

					db.transaction(function(transaction) {
						transaction.executeSql(
								'DELETE FROM Expense WHERE Budget = ?;',
								[id],
								nullHandler, errorHandler);
					});
				}

				ListDBValues();
				GetName(id);
				return false;
			}

			function updateBudget(){
				var id = $('#Myid').val();
				db.transaction(
				    function (transaction) {
				    	if( ($('#bdgtnm').val() != '') && ($('#trgt').val() != '') ) {
				    		var bdgtnm = $('#bdgtnm').val();
				    		var trgt = $('#trgt').val();
				    	} else {
				    		var bdgtnm = 'none';
				    		var trgt = 'none';
				    	}
					

				    	transaction.executeSql('UPDATE BudgetDB SET Name=?, Target=? WHERE BudgetId = ?;', [bdgtnm, trgt, id]);
				    }
				);
				ListDBValues();
				GetName(id);
				return false;
			}

		</script>


        <title>Budget Planner</title>
    </head>

    <body onload="onBodyLoad()">
    
    	<div id="fb-root"></div>
		<script>
			(function(d, s, id) {
			  var js, fjs = d.getElementsByTagName(s)[0];
			  if (d.getElementById(id)) return;
			  js = d.createElement(s); js.id = id;
			  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=170509146458314";
			  fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));
		</script>
    
   		<div data-role="page" id="mainpage" onload="onBodyLoad()">
   		
			<div data-role="header">
    			<h1>Home</h1>
  			</div>

			<div data-role="content">
  				<a href="#addBudget" data-role="button" onClick="clearAddBudgetField()">Add Budget</a>
  				<div data-role="collapsible" data-collapsed="true" data-theme="b" data-content-theme="b" data-collapsed-icon="carat-d" data-expanded-icon="carat-u">
					<h2>View Budget List</h2>
						<input type="hidden" id="currentBudgetID">
						<div id="Budgets"></div>
					
				</div>
  			</div>
		</div>

		<div data-role="page" id="addBudget" >
			<div data-role="header">
				<h1>Add Budget</h1>
			</div>
			<div data-role="content">
				<p>This is where you will add a new budget</p>
				<input type="text" placeholder="Budget name" id="txName">
				<input type="text" placeholder="Income" id="txMoney">
				<label for="Target">Target Savings:</label>
				<input type="range" id="txTarget" min="0">
				<script>
					document.write('<input type="hidden" id="txDateCreated" value="'+ new Date() +'">');
				</script>
				<a href="#mainpage" class="ui-btn" onClick="AddValueToDB()">Add Budget</a>
				<br>
				<a href="#mainpage" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back ui-btn-b">Back</a>

			</div>
		</div>

		<div data-role="page" id="viewSummaryPage"></div>
		
		<div data-role="page" id="addExpensePage" >
			<div data-role="header">
				<a href="#mainpage" class="ui-btn-left ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-home">Home</a>
				<h1>Add Expense</h1>
			</div>
			<div data-role="content">
				<p>This is where you will add a new expense</p>
				<fieldset class="ui-field-contain">
    					<label for="category">Select Category</label>
    					<select name="category" id="txCategory">
      						<option value="Food">Food / Beverages</option>
      						<option value="Transportation">Transportation</option>
      						<option value="Education">Education</option>
							<option value="Clothing">Clothing</option>
							<option value="Personal">Personal</option>
							<option value="Home">Home</option>
							<option value="Other">Other</option>
    					</select>
  				</fieldset>
				<input type="text" placeholder="Description" id="txDescription">
				<input type="text" placeholder="Amount" id="txAmount">
				<input type="text" placeholder="Number of Occurence per month" id="txOccurence">
				<script>
					document.write('<input type="hidden" id="txDate" value="'+ new Date() +'">');
				</script>				
								
				
				<a class="ui-btn" onClick="AddExpense()">Add Expense</a>
				<br>
				
				<a href="#editBudget" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back ui-btn-b">Back</a>
				
			</div>
		</div>
		
		<div data-role="page" id="editBudget" onload="onBodyLoad()">
			<div data-role="header">
				<h1>Edit Budget</h1>
			</div>
			<div data-role="content">
				<div class="fb-share-button" data-href="https://www.facebook.com/" data-type="button"></div><br>
				<b>Budget Name: <small id="MyName"></small></b><br>
				<b>Budget Money: ₱<small id="MyMoney"></small></b><br>
				<b>Target: ₱<small id="MyTarget"></small></b>
				<br>
				<br>
				<h3>Remaining Daily Budget: </h3><h2 id="dailyBudget"></h2>
				<br>
				<h3>Remaining Monthly Budget: </h3><h2 id="monthlyBudget"></h2>
				</script>

				<a href="#addExpensePage" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-plus ui-btn-b" onClick="clearAddExpenseField()">Add Expense</a>
				<br>
				<a href="#viewSummaryPage" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left  ui-icon-grid ui-btn-b" onCLick="viewSummary()">Summary</a>
				<br>
				<a href="#mainpage" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-back ui-btn-b">Back</a>

			</div>
			<div data-role="footer" data-theme="b" data-position="fixed" style="text-align:center;">
				<a href="#popupedit" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-icon-edit ui-btn-icon-left ui-btn-b" data-transition="pop">Edit Budget</a>
				<div data-role="popup" id="popupedit" data-theme="a" class="ui-corner-all">
				    <form>
				        <div style="padding:10px 20px;">
				            <h3>Edit your budget</h3>
				            <input type="hidden" id = "Myid" for="Myid"></input>
				            <label for="bdgtnm" class="ui-hidden-accessible">Budget Name:</label>
				            <input type="text" name="budget_name" id="bdgtnm" value="" placeholder="budget name" data-theme="a">
				            <label for="trgt" class="ui-hidden-accessible">Target:</label>
				            <input type="number" name="budget_target" pattern="[0-9]*" id="trgt" value="" data-theme="a" placeholder="target">
				            <a href="#editBudget" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-b ui-icon-edit" onClick="updateBudget()">Update</a>
							<a href="#editBudget" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-b ui-icon-arrow-l">Cancel</a>	
				        </div>
				    </form>
				</div>
				<a href="#mainpage" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-delete ui-btn-b" onClick="DeleteBudget()">Delete Budget</a>
				<!-- <a href="http://developers.facebook.com/docs/plugins/" class="fb-share-button ui-btn ui-btn-b"></a> -->
			</div>
		</div>

   
    </body>
</html>
